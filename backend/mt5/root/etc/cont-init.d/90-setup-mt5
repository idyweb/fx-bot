#!/command/with-contenv bash

echo "Fixing permissions for /config..."
chown -R abc:abc /config

# Ensure environment variables are set for the abc user context
export WINEARCH=win64
export WINEPREFIX="/config/.wine"
export DISPLAY=:0
export HOME=/config

# Fix XDG_RUNTIME_DIR for Wine
export XDG_RUNTIME_DIR=/tmp/runtime-abc
mkdir -p "$XDG_RUNTIME_DIR"
chown abc:abc "$XDG_RUNTIME_DIR"
chmod 0700 "$XDG_RUNTIME_DIR"

echo "Running installation scripts as abc..."

exec s6-setuidgid abc /bin/bash -c '
    export WINEARCH=win64
    export WINEPREFIX="/config/.wine"
    export DISPLAY=:0
    export HOME=/config
    export XDG_RUNTIME_DIR=/tmp/runtime-abc
    
    /scripts/03-install-mono.sh
    /scripts/04-install-mt5.sh
    /scripts/05-install-python.sh
    /scripts/06-install-libraries.sh
'
